<html>
<title>runDE</title>
<body style="padding:20px;width:650px;font-family:Times;">
<h1>Differential expression (DE)</h1>

This tool allows you to define groups of conditions and compute their 
differential expression, either using R package edgeR or DESeq2, or supplying
an R-script for a given R package that computes DE. 
 
DE-enriched GO categories can also be found using GOSeq.
See the Online Guide for assistance installing the R packages.

<h2>Compute p-values for DE</h2>
The following gives the basic facts. Details can be found in the last section.
<p>
METHOD:
<ol>
<li><u>R-script</u>: select a file that contains R commands.
Two files are provided as example, edgeR.R and DESeq.R.
</ol>
<p>
OPTIONS:
<ol>
<li>Pre-filter:
<ul>
<li><u>Count</u>: any sequence that does not have at least one sample with counts >cutoff is not evaluated. 
<li><u>CPM</u>: This has two parameters, say N and M.
Any sequence that does not have CPM &gt; N for &gt;= M samples is not evaluated.
The CPM for a sequence is the (count/sample_size) * 1E6. For example, if there are 2 conditions
with 3 replicates each, and N=20 and M=2, then at least 2 of the 6 samples
must have CPM&gt;20. 

<li><u>None</u>: no filtering.
</ul>
<p>If you want to see the first 25 (non-zero) filtered sequences, then use:
<pre>
		runDE [database_name] -v
</pre>
The values will be written to the terminal near the top of the output.

<p><i>When viewing the results in <tt>viewSingleTCW</tt>,
the filtered sequences will have a 3 for the DE value. If the DE analysis return a
NA, it will also have a value of 3.</i>
<p>
<li><u>Fixed dispersion</u>: used when there are no replicates. 
<ul>
<li>For edgeR, if there are no replicates and this is not set, it will use a 0.1 dispersion. 
<li>DESeq2 does not use a  fixed dispersion (see its documentation). 
<li>This value will be written to the R environment using the variable 'disp' if an R-script is being used.
</ul>

</ol>
EXECUTE:
<ol>
<li><u>Group 1 - Group 2</u>: 
<ul>
<li>Select at least one condition from each group.
<li>If you want to store the results in the database, check <u>Save results in P-value column</u>.
If the groups have been selected, a column name will be auto-generated which you can change.
When you change the groups for a subsequent execution, uncheck-then-check the column box
to auto-generated a name for the new groups.
<li>The condition(s) in Group 1 will be compared with the condition(s) in group 2.
</ul>
<li><u>All Pairs for Group 1</u>: 
<ul>
<li>Only check conditions in Group 1.
<li>Results will be saved in the database with auto-generated column names.
<li>Each pair of conditions selected in group 1 will compared; any selections
in Group 2 are ignored.
</ul>
<li><u>All Pairs from File</u>: 
<ul>
<li>The Condition section is ignored; the conditions to
compare are specified in the file (see file format in "Details").
<li>Results will be saved in the database with the provided column names.
<li>All pairs from the file will be compared with the selected method
and options.
</ul>
<li><u>P-values from file</u>
<ul>
<li>The Conditions, METHOD, and OPTIONS sections are ignored, and R is not used.
<li>The p-values are read from file (see "Details" for file format). 
</ul>
</ol>
<p><i>A p-value does not distinguish whether condition 1 is greater than condition 2 or vice versa.
Therefore, if the RPKM for condition 1 is less than the RPKM condition 2, 
a negative sign is put before the p-value.</i>

<p>The first three options will leave your terminal in the "R environment", described
in the section below.

<!----------------------------------------------------!>
<h2>Column Operations</h2>
Select p-value column: 
<ul>
<li>Select with left mouse to see all choices.
<li>Select with right mouse to click through choices.
<li>The "All p-value columns" apply to all columns.
</ul>
Select <u>Remove</u> to remove the selected column(s) and corresponding GOseq column (if it exists).
<p>
Select <u>Execute GOseq</u> to run the GOseq function on the selected column(s), where
GOseq detects GO which are over/under represented.
 The data will be entered into the GO table of the database using the p-value column name.
 If the GOseq p-value column exists, it will overwrite the existing value.
Cutoff:
<ol>
<li>P-value: if a sequence a DE p-value less than this amount (e.g. 0.05), 
it is considered DE. GOseq
takes as input the information as to whether or not each sequence is DE, 
where a 1 indicates it is and a 0 indicates it is not. 
<li>Top X%: instead of a p-value, you can request that the X% of the sequences with the
lowest DE be considered DE for input to GOseq.
</ol> 
<!----------------------------------------------------!>
<h2>Update, Close and Exit</h2>
<ol>
<li><u>Update Overview</u>:
The "Overview" needs to be updated after changes to the DE columns.
It will also display the overview; if there have been no changes, it will only display.
<li><u>Close</u>: Close the window, but do not exit the R environment (if active).
<li><u>Exit</u>: Close the window, and if there are no other active <tt>runDE</tt>
windows, exit R.
</ol>
<!----------------------------------------------------!>
<h3>R environment</h3>
At the end of execution, the terminal will be in the "R environment" so that you can execute
R commands to view graphs of the results. You can tell when it is in the R environment because there is only a ">" for the prompt.

<p>To exit the R environment,  enter <tt>q()</tt>; it will ask
you if you want to 
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<tt>Save workspace image? [y/n/c]</tt>:
<ul>
<li> y - exit and saves the environment; you can later restart R
<li> n - exit and and do not save the environment
<li> c - do not exit -- continue
</ul>
<p>
However, when <tt>runDE</tt> writes to the terminal, you will no longer see the ">"; hit
carriage return and you will get the "<tt>Save workspace image?</tt>" prompt. 
<p>
Some R commands of interest:
<ul>
<li>Type <tt>ls()</tt> to list the defined variables. 
<li>Type a variable name to view its
contents. 
<li>The build-in methods print ways to display a plot, e.g. for
<tt>edgeR</tt>,  it says "<tt>Scatter plot: plotBCV(y)</tt>".
</ul>
When querying the R environment from <tt>runDE</tt>, the scroll keys may not work.
In order to use the scroll keys,
type q(), followed by 'y', then start the R environment from the command line. 
<!----------------------------------------------------!>
<hr>
<h2>Details</h2>
<h3>Select conditions</h3>

<p>
Ordinarily you should pick exactly one condition for each group, creating a two-condition comparison.
In this case, any replicates in the conditions will automatically be used by those methods (EdgeR,DESeq2) 
which employ replicates.
<p>
You can also form groups having more than one condition, in which case the conditions in a given
group will be treated as replicates. This is not recommended unless the conditions are
expected to be quite similar; instead, you can run the desired pairwise comparisons, and then
use the filtering functions in <tt>viewSingleTCW</tt> to construct filters involving DE among
multiple conditions.
<p>
If you will be comparing multiple single TCW databases using the multi-TCW programs, make
sure that the condition names and DE column names are the same.

<h3>Get Pairs from File</h3>
The file can have many rows, where each line contains three columns separated by blanks.
The first column is group1, the second is group2, and the third is the 
p-value column name. If
you want multiple conditions for group1, separate them with colons. For example:
<pre>
root stem RoSt
root rhiz RoRz
root:rhiz stem RRxStS
</pre>
This will run the selected method on these three sets and create columns RoST, RoRz, RRxST.
The third entry uses two conditions for the first group.
<p>It will overwrite any existing p-value columns with the same name.
<p>Blank lines and lines starting with '#' are ignored.

<h3>P-values from File</h3>
The first line defines the two groups and the p-value column name, using the same format
as the "Get Pairs from File". All remaining lines have
a <tt>seqID</tt> followed by the p-value. For example,
<pre>
#Example p-value file 
root stem RoSt
tra_001	0.14
tra_002	0.14
tra_003	0.65
</pre>
The p-values are read as absolute values since <tt>runDE</tt> makes values negative if
Cond1&lt;Cond2.
<h3>R-scripts</h3>
For each pair (from any of the Execute approaches):
<ol>
<li>R is started, and the following values are written to the R environment:
<ul>
<li><i>countData</i>: count values are written to a matrix where the row names are the
sequence names.
<li><i>grpNames</i>: an array of the column names by group. For example, if Root and Rhiz
are selected as Group 1 and Group 2, the values in this array will be:
<tt>
root, root, root, rhiz, rhiz, rhiz
</tt>
<li>Other variables are also written. To view them, execute a built-in or existing script;
the variables are written to standard out with explanations.
</ul>
<li>The R-script is execute with the "source" command.
<li>The results should be in an array called <i>results</i>, which is read by TCW.  Also,
<i>rowNames</i> is read and should be in the same order as the <i>results</i>; this array
is created before the R-script execution, so if the order is not changes, it does not
need to be changed.
</ol>
See the existing scripts for example.
</html>